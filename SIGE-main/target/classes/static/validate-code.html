<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Validar Código — SIGE</title>

    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#3b82f6', secondary: '#1e40af' },
                    borderRadius: { 'button': '8px' }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50 flex items-center justify-center p-6">
<div class="w-full max-w-md">
    <div class="text-center mb-6">
        <h1 class="font-['Pacifico'] text-4xl text-primary mb-1">SIGE</h1>
        <p class="text-gray-600">Informe o código enviado ao seu e-mail</p>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">Código de verificação</h2>
        <p class="text-sm text-gray-600 mb-4">Digite os 6 dígitos recebidos por e-mail.</p>

        <form id="codeForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                <input id="email" type="email" readonly
                       class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-50 text-sm" />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Código</label>
                <input id="code" inputmode="numeric" pattern="[0-9]*" maxlength="6" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm"
                       placeholder="123456" />
            </div>

            <div id="message" aria-live="polite"></div>

            <div class="grid grid-cols-2 gap-3">
                <button id="validateBtn" type="submit" class="bg-primary text-white py-3 rounded-button">Validar</button>
                <button id="resendBtn" type="button" class="border border-gray-200 py-3 rounded-button">Reenviar código</button>
            </div>

            <div class="text-center mt-3">
                <a href="forgot-password.html" class="text-sm text-primary hover:text-secondary">Alterar e-mail</a>
            </div>
        </form>
    </div>

    <footer class="mt-6 text-center text-sm text-gray-500">
        <p>&copy; 2025 SIGE</p>
    </footer>
</div>

<script>
    const API_BASE = 'http://localhost:8081/api/auth';
    const emailInput = document.getElementById('email');
    const codeInput = document.getElementById('code');
    const messageBox = document.getElementById('message');
    const validateBtn = document.getElementById('validateBtn');
    const resendBtn = document.getElementById('resendBtn');

    const storedEmail = sessionStorage.getItem('sige_forgot_email');
    if (!storedEmail) {
        // Se não encontrou e-mail, volta para página inicial do forgot
        window.location.href = 'forgot-password.html';
    } else {
        emailInput.value = storedEmail;
    }

    function showMessage(text, type='info') {
        messageBox.innerHTML = `<div class="p-3 rounded-md ${type==='error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'} text-sm">${text}</div>`;
    }

    document.getElementById('codeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = emailInput.value.trim();
        const codigo = codeInput.value.trim();

        if (!/^\d{6}$/.test(codigo)) { showMessage('Digite o código de 6 dígitos.', 'error'); return; }

        validateBtn.disabled = true;
        validateBtn.textContent = 'Validando...';

        try {
            const res = await fetch(`${API_BASE}/validate-code`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, codigo })
            });
            const data = await res.json();

            if (data.status === 'success') {
                showMessage(data.message || 'Código válido. Redirecionando…');
                // Avança para redefinir senha
                setTimeout(() => { window.location.href = 'reset-password.html'; }, 900);
            } else {
                showMessage(data.message || 'Código inválido.', 'error');
            }
        } catch (err) {
            console.error(err);
            showMessage('Erro ao conectar com o servidor.', 'error');
        } finally {
            validateBtn.disabled = false;
            validateBtn.textContent = 'Validar';
        }
    });

    resendBtn.addEventListener('click', async () => {
        resendBtn.disabled = true;
        resendBtn.textContent = 'Reenviando...';
        try {
            const res = await fetch(`${API_BASE}/forgot`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: emailInput.value })
            });
            const data = await res.json();
            if (data.status === 'success') {
                showMessage(data.message || 'Código reenviado.');
            } else {
                showMessage(data.message || 'Erro ao reenviar.', 'error');
            }
        } catch (err) {
            console.error(err);
            showMessage('Erro ao conectar com o servidor.', 'error');
        } finally {
            resendBtn.disabled = false;
            resendBtn.textContent = 'Reenviar código';
        }
    });
</script>
</body>
</html>
